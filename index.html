<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de L√¢mpadas</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  h1 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    font-size: 28px;
  }
  
  .connection-panel {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    border-left: 4px solid #667eea;
  }
  
  .connection-panel h3 {
    color: #555;
    margin-bottom: 10px;
    font-size: 16px;
  }
  
  .input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  #ip-input {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s;
  }
  
  #ip-input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  #connect-btn {
    padding: 12px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  #connect-btn:hover {
    background: #5a67d8;
  }
  
  #connect-btn.connected {
    background: #4CAF50;
  }
  
  #connect-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }
  
  .connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ccc;
  }
  
  .status-dot.connected {
    background: #4CAF50;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  .status-message {
    font-size: 14px;
    color: #666;
  }
  
  .status-message.success {
    color: #4CAF50;
    font-weight: 600;
  }
  
  .status-message.error {
    color: #f44336;
    font-weight: 600;
  }
  
  .controls-section {
    opacity: 0.5;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  
  .controls-section.enabled {
    opacity: 1;
    pointer-events: all;
  }
  
  .lamp-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .lamp-card {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    border: 2px solid #e9ecef;
    cursor: pointer;
  }
  
  .lamp-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  
  .lamp-card.on {
    border-color: #4CAF50;
    background: linear-gradient(135deg, #f8fff8 0%, #e8f5e9 100%);
  }
  
  .lamp-card.off {
    border-color: #f44336;
    background: linear-gradient(135deg, #fff8f8 0%, #ffebee 100%);
  }
  
  .lamp-icon {
    font-size: 40px;
    margin-bottom: 10px;
  }
  
  .lamp-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
  }
  
  .status-indicator {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }
  
  .status-on {
    background: #4CAF50;
    color: white;
  }
  
  .status-off {
    background: #f44336;
    color: white;
  }
  
  .toggle-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 10px;
  }
  
  .toggle-btn.on {
    background: #4CAF50;
    color: white;
  }
  
  .toggle-btn.off {
    background: #f44336;
    color: white;
  }
  
  .toggle-btn:hover {
    opacity: 0.9;
  }
  
  .global-controls {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  .global-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .global-btn.on {
    background: #4CAF50;
    color: white;
  }
  
  .global-btn.off {
    background: #f44336;
    color: white;
  }
  
  .global-btn:hover {
    opacity: 0.9;
  }
  
  @media (max-width: 600px) {
    .lamp-grid {
      grid-template-columns: 1fr;
    }
    
    .container {
      padding: 20px;
    }
    
    .input-group {
      flex-direction: column;
    }
    
    #connect-btn {
      width: 100%;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>üí° Controle de L√¢mpadas</h1>
  
  <div class="connection-panel">
    <h3>Conex√£o com Arduino:</h3>
    <div class="input-group">
      <input id="ip-input" type="text" value="169.254.92.19" placeholder="Digite o IP do Arduino">
      <button id="connect-btn">Conectar</button>
    </div>
    <div class="connection-status">
      <div class="status-dot" id="status-dot"></div>
      <div class="status-message" id="status-message">Aguardando conex√£o...</div>
    </div>
  </div>
  
  <div class="controls-section" id="controls-section">
    <div class="lamp-grid">
      <!-- L√¢mpada 1 -->
      <div class="lamp-card off" data-lamp="1" onclick="toggleLamp(1)">
        <div class="lamp-icon">üí°</div>
        <div class="lamp-title">L√¢mpada 1</div>
        <div class="status-indicator status-off">DESLIGADA</div>
        <button class="toggle-btn off" onclick="event.stopPropagation(); toggleLamp(1)">
          LIGAR
        </button>
      </div>
      
      <!-- L√¢mpada 2 -->
      <div class="lamp-card off" data-lamp="2" onclick="toggleLamp(2)">
        <div class="lamp-icon">üí°</div>
        <div class="lamp-title">L√¢mpada 2</div>
        <div class="status-indicator status-off">DESLIGADA</div>
        <button class="toggle-btn off" onclick="event.stopPropagation(); toggleLamp(2)">
          LIGAR
        </button>
      </div>
      
      <!-- L√¢mpada 3 -->
      <div class="lamp-card off" data-lamp="3" onclick="toggleLamp(3)">
        <div class="lamp-icon">üí°</div>
        <div class="lamp-title">L√¢mpada 3</div>
        <div class="status-indicator status-off">DESLIGADA</div>
        <button class="toggle-btn off" onclick="event.stopPropagation(); toggleLamp(3)">
          LIGAR
        </button>
      </div>
      
      <!-- L√¢mpada 4 -->
      <div class="lamp-card off" data-lamp="4" onclick="toggleLamp(4)">
        <div class="lamp-icon">üí°</div>
        <div class="lamp-title">L√¢mpada 4</div>
        <div class="status-indicator status-off">DESLIGADA</div>
        <button class="toggle-btn off" onclick="event.stopPropagation(); toggleLamp(4)">
          LIGAR
        </button>
      </div>
    </div>
    
    <div class="global-controls">
      <button class="global-btn on" onclick="turnAllOn()">Ligar Todas</button>
      <button class="global-btn off" onclick="turnAllOff()">Desligar Todas</button>
    </div>
  </div>
</div>

<script>
// Estado das l√¢mpadas (false = desligada, true = ligada)
const lampStates = {
  1: false,
  2: false,
  3: false,
  4: false
};

// Estado da conex√£o
let isConnected = false;

// Mapeamento de comandos
const commands = {
  on: {
    1: '1',  // Liga l√¢mpada 1
    2: '3',  // Liga l√¢mpada 2
    3: '5',  // Liga l√¢mpada 3
    4: '7'   // Liga l√¢mpada 4
  },
  off: {
    1: '2',  // Desliga l√¢mpada 1
    2: '4',  // Desliga l√¢mpada 2
    3: '6',  // Desliga l√¢mpada 3
    4: '8'   // Desliga l√¢mpada 4
  }
};

// Elementos DOM
const ipInput = document.getElementById('ip-input');
const connectBtn = document.getElementById('connect-btn');
const statusDot = document.getElementById('status-dot');
const statusMessage = document.getElementById('status-message');
const controlsSection = document.getElementById('controls-section');

// Fun√ß√£o para testar conex√£o com o Arduino
async function testConnection() {
  const ip = ipInput.value.trim();
  
  if (!ip) {
    showStatusMessage('Por favor, insira o IP do Arduino!', 'error');
    return false;
  }
  
  // Desabilitar bot√£o durante a tentativa de conex√£o
  connectBtn.disabled = true;
  connectBtn.textContent = 'Conectando...';
  showStatusMessage('Testando conex√£o...', 'info');
  
  try {
    // Tentar fazer uma requisi√ß√£o simples ao Arduino
    // Usamos fetch com timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // Timeout de 5 segundos
    
    const response = await fetch(`http://${ip}/`, {
      method: 'GET',
      mode: 'no-cors', // Modo no-cors para evitar problemas de CORS
      signal: controller.signal
    }).catch(error => {
      if (error.name === 'AbortError') {
        throw new Error('Timeout: O Arduino n√£o respondeu em 5 segundos');
      }
      throw error;
    });
    
    clearTimeout(timeoutId);
    
    // Se chegou aqui, a conex√£o foi bem-sucedida
    isConnected = true;
    connectBtn.classList.add('connected');
    connectBtn.textContent = 'Conectado!';
    statusDot.classList.add('connected');
    showStatusMessage('‚úÖ Conectado com sucesso ao Arduino!', 'success');
    
    // Habilitar controles das l√¢mpadas
    controlsSection.classList.add('enabled');
    
    // Salvar IP no localStorage para uso futuro
    localStorage.setItem('arduinoIP', ip);
    
    return true;
    
  } catch (error) {
    console.error('Erro na conex√£o:', error);
    
    // Tentar m√©todo alternativo (usando Image como antes)
    return new Promise((resolve) => {
      const testImg = new Image();
      const testTimeout = setTimeout(() => {
        showStatusMessage('‚ùå Falha na conex√£o. Verifique o IP e a rede.', 'error');
        connectBtn.disabled = false;
        connectBtn.textContent = 'Tentar Novamente';
        resolve(false);
      }, 3000);
      
      testImg.onload = function() {
        clearTimeout(testTimeout);
        isConnected = true;
        connectBtn.classList.add('connected');
        connectBtn.textContent = 'Conectado!';
        statusDot.classList.add('connected');
        showStatusMessage('‚úÖ Conectado com sucesso ao Arduino!', 'success');
        controlsSection.classList.add('enabled');
        localStorage.setItem('arduinoIP', ip);
        resolve(true);
      };
      
      testImg.onerror = function() {
        clearTimeout(testTimeout);
        showStatusMessage('‚ùå Falha na conex√£o. Verifique o IP e a rede.', 'error');
        connectBtn.disabled = false;
        connectBtn.textContent = 'Tentar Novamente';
        resolve(false);
      };
      
      testImg.src = `http://${ip}/?test=${Date.now()}`;
    });
  }
}

// Fun√ß√£o para mostrar mensagens de status
function showStatusMessage(message, type = 'info') {
  statusMessage.textContent = message;
  statusMessage.className = 'status-message';
  
  if (type === 'success') {
    statusMessage.classList.add('success');
  } else if (type === 'error') {
    statusMessage.classList.add('error');
  }
}

// Fun√ß√£o para enviar comando ao Arduino
function sendCommand(cmd) {
  if (!isConnected) {
    showStatusMessage('‚ö†Ô∏è Conecte-se primeiro ao Arduino!', 'error');
    return false;
  }
  
  const ip = ipInput.value.trim();
  
  if (!ip) {
    showStatusMessage('Por favor, insira o IP do Arduino!', 'error');
    return false;
  }
  
  // Usar Image para fazer requisi√ß√£o GET (evita CORS)
  const img = new Image();
  img.src = `http://${ip}/?${cmd}`;
  
  console.log(`Comando enviado: ${cmd} para IP: ${ip}`);
  
  return true;
}

// Fun√ß√£o para alternar estado da l√¢mpada
function toggleLamp(lampNumber) {
  if (!isConnected) {
    showStatusMessage('‚ö†Ô∏è Conecte-se primeiro ao Arduino!', 'error');
    return;
  }
  
  const newState = !lampStates[lampNumber];
  lampStates[lampNumber] = newState;
  
  // Determinar qual comando enviar
  const cmd = newState ? commands.on[lampNumber] : commands.off[lampNumber];
  
  // Enviar comando para o Arduino
  if (sendCommand(cmd)) {
    // Atualizar interface
    updateLampUI(lampNumber, newState);
    showStatusMessage(`‚úÖ L√¢mpada ${lampNumber} ${newState ? 'ligada' : 'desligada'}`, 'success');
  }
}

// Fun√ß√£o para atualizar interface da l√¢mpada
function updateLampUI(lampNumber, isOn) {
  const lampCard = document.querySelector(`[data-lamp="${lampNumber}"]`);
  const indicator = lampCard.querySelector('.status-indicator');
  const button = lampCard.querySelector('.toggle-btn');
  
  if (isOn) {
    lampCard.classList.remove('off');
    lampCard.classList.add('on');
    indicator.classList.remove('status-off');
    indicator.classList.add('status-on');
    indicator.textContent = 'LIGADA';
    button.classList.remove('off');
    button.classList.add('on');
    button.textContent = 'DESLIGAR';
  } else {
    lampCard.classList.remove('on');
    lampCard.classList.add('off');
    indicator.classList.remove('status-on');
    indicator.classList.add('status-off');
    indicator.textContent = 'DESLIGADA';
    button.classList.remove('on');
    button.classList.add('off');
    button.textContent = 'LIGAR';
  }
}

// Fun√ß√£o para ligar todas as l√¢mpadas
function turnAllOn() {
  if (!isConnected) {
    showStatusMessage('‚ö†Ô∏è Conecte-se primeiro ao Arduino!', 'error');
    return;
  }
  
  for (let i = 1; i <= 4; i++) {
    if (!lampStates[i]) {
      sendCommand(commands.on[i]);
      lampStates[i] = true;
      updateLampUI(i, true);
    }
  }
  showStatusMessage('‚úÖ Todas as l√¢mpadas ligadas', 'success');
}

// Fun√ß√£o para desligar todas as l√¢mpadas
function turnAllOff() {
  if (!isConnected) {
    showStatusMessage('‚ö†Ô∏è Conecte-se primeiro ao Arduino!', 'error');
    return;
  }
  
  for (let i = 1; i <= 4; i++) {
    if (lampStates[i]) {
      sendCommand(commands.off[i]);
      lampStates[i] = false;
      updateLampUI(i, false);
    }
  }
  showStatusMessage('‚úÖ Todas as l√¢mpadas desligadas', 'success');
}

// Event Listeners
connectBtn.addEventListener('click', testConnection);

ipInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    testConnection();
  }
});

// Carregar IP salvo do localStorage, se existir
window.addEventListener('load', () => {
  const savedIP = localStorage.getItem('arduinoIP');
  if (savedIP) {
    ipInput.value = savedIP;
  }
  
  // Focar no campo IP
  ipInput.focus();
  ipInput.select();
});
</script>

</body>
          </html>
