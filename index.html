<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Lâmpadas</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color:#f5f5f5; padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; }
        .container { background-color:white; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1); padding:25px; width:100%; max-width:500px; }
        h1 { text-align:center; margin-bottom:25px; color:#333; }
        .ip-config { margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #eee; }
        label { display:block; margin-bottom:8px; font-weight:500; color:#555; }
        input[type="text"] { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:16px; }
        .connect-btn, .all-btn { margin-top:10px; padding:10px 15px; background-color:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; font-size:14px; }
        .connect-btn:hover, .all-btn:hover { background-color:#45a049; }
        .connect-btn:disabled { background-color:#cccccc; cursor:not-allowed; }
        .connection-status { margin-top:10px; padding:8px; border-radius:5px; text-align:center; font-size:14px; display:none; }
        .connection-status.connected { background-color:#e8f5e9; color:#2e7d32; display:block; }
        .connection-status.disconnected { background-color:#ffebee; color:#c62828; display:block; }
        .lampadas { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
        .lampada { background-color:#f9f9f9; border-radius:8px; padding:15px; text-align:center; cursor:pointer; transition:all 0.3s ease; border:1px solid #e0e0e0; }
        .lampada:hover { transform:translateY(-3px); box-shadow:0 5px 10px rgba(0,0,0,0.1); }
        .lampada h3 { margin-bottom:10px; color:#333; }
        .lampada.off { background-color:#ffebee; }
        .lampada.on { background-color:#e8f5e9; }
        .status { font-weight:bold; font-size:14px; padding:5px 10px; border-radius:20px; display:inline-block; }
        .status.off { background-color:#f44336; color:white; }
        .status.on { background-color:#4caf50; color:white; }
        .message { margin-top:20px; padding:10px; border-radius:5px; text-align:center; font-size:14px; display:none; }
        .message.success { background-color:#e8f5e9; color:#2e7d32; display:block; }
        .message.error { background-color:#ffebee; color:#c62828; display:block; }
        .loading { opacity:0.7; pointer-events:none; }
        .all-btn { width:48%; display:inline-block; margin-right:2%; }
        .all-btn:last-child { margin-right:0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Lâmpadas</h1>
        
        <div class="ip-config">
            <label for="ip">IP do Arduino:</label>
            <input type="text" id="ip" placeholder="Ex: 192.168.1.50">
            <button class="connect-btn" id="connectBtn">Conectar</button>
            <div class="connection-status" id="connectionStatus"></div>
        </div>

        <div class="lampadas">
            <div class="lampada off" data-lamp="1"><h3>Lâmpada 1</h3><div class="status off">DESLIGADA</div></div>
            <div class="lampada off" data-lamp="2"><h3>Lâmpada 2</h3><div class="status off">DESLIGADA</div></div>
            <div class="lampada off" data-lamp="3"><h3>Lâmpada 3</h3><div class="status off">DESLIGADA</div></div>
            <div class="lampada off" data-lamp="4"><h3>Lâmpada 4</h3><div class="status off">DESLIGADA</div></div>
        </div>

        <div style="margin-bottom:15px;">
            <button class="all-btn" id="turnAllOn">Ligar Todas</button>
            <button class="all-btn" id="turnAllOff">Desligar Todas</button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <script>
    
  // ===== VARIÁVEIS GLOBAIS =====
  let arduinoIP = localStorage.getItem('arduino_ip') || '';
  let lampadasEstado = [false, false, false, false];
  let systemLogs = JSON.parse(localStorage.getItem('system_logs') || '[]');

  // ===== NAVEGAÇÃO =====
  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

    document.getElementById(sectionId).style.display = 'block';
    event.target.classList.add('active');

    if (sectionId === 'logs') atualizarLogs();
  }

  // ===== TOGGLE & CONTROLE =====
  function toggleSwitch(element, lampadaId) {
    const index = lampadaId - 1;
    const novoEstado = !lampadasEstado[index];

    lampadasEstado[index] = novoEstado;
    element.classList.toggle("on", novoEstado);

    const card = element.closest('.card');
    const status = card.querySelector('.status');
    status.textContent = novoEstado ? "ON" : "OFF";
    status.className = `status ${novoEstado ? "on" : "off"}`;

    controlarLampada(lampadaId, novoEstado);
  }

  function controlarLampada(lampadaId, ligar) {
    if (!arduinoIP) {
      alert('Configure primeiro o IP do Arduino!');
      return;
    }

    const comando = ligar ? 'on' : 'off';
    const endpoint = `/lamp${lampadaId}=${comando}`;

    adicionarLog(`Enviando comando: Lâmpada ${lampadaId} ${comando.toUpperCase()}`, 'info');

    fetch(`http://${arduinoIP}${endpoint}`)
      .then(response => {
        if (response.ok) {
          lampadasEstado[lampadaId - 1] = ligar;
          adicionarLog(`Lâmpada ${lampadaId} ${comando.toUpperCase()} com sucesso`, 'success');
        } else {
          adicionarLog(`Erro ao controlar Lâmpada ${lampadaId}`, 'error');
          reverterEstado(lampadaId);
        }
      })
      .catch(error => {
        adicionarLog(`Falha na conexão com Arduino: ${error.message}`, 'error');
        alert('Erro ao conectar com o Arduino. Verifique o IP e a conexão.');
        reverterEstado(lampadaId);
      });
  }

  function reverterEstado(lampadaId) {
    const index = lampadaId - 1;
    lampadasEstado[index] = !lampadasEstado[index];

    const card = document.querySelectorAll('.card')[index];
    const toggle = card.querySelector('.toggle');
    const status = card.querySelector('.status');

    toggle.classList.toggle('on', lampadasEstado[index]);
    status.textContent = lampadasEstado[index] ? "ON" : "OFF";
    status.className = `status ${lampadasEstado[index] ? "on" : "off"}`;
  }

  // ===== IP DO ARDUINO =====
  function salvarIP() {
    const ipInput = document.getElementById('arduinoIP');
    const ip = ipInput.value.trim();

    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ip || !ipRegex.test(ip)) {
      alert('Por favor, insira um IP válido (ex: 192.168.1.77)');
      return;
    }

    arduinoIP = ip;
    localStorage.setItem('arduino_ip', ip);
    adicionarLog(`IP do Arduino atualizado para: ${ip}`, 'success');
    alert(`IP do Arduino salvo: ${ip}`);
  }

  // ===== FUNÇÕES DE LOG =====
  function adicionarLog(mensagem, tipo) {
    const log = {
      id: Date.now(),
      timestamp: new Date().toLocaleString('pt-BR'),
      message: mensagem,
      type: tipo
    };

    systemLogs.unshift(log);
    if (systemLogs.length > 100) systemLogs.pop();

    localStorage.setItem('system_logs', JSON.stringify(systemLogs));
    atualizarLogs();
  }

  function atualizarLogs() {
    const logList = document.getElementById('logList');
    logList.innerHTML = '';
    systemLogs.forEach(log => {
      const div = document.createElement('div');
      div.className = `log-item`;
      div.innerHTML = `
        <div class="log-time">${log.timestamp}</div>
        <div class="log-message">${log.message}</div>
        <div class="log-type ${log.type === 'success' ? 'log-success' : log.type === 'error' ? 'log-error' : 'log-info'}">
          ${log.type.toUpperCase()}
        </div>`;
      logList.appendChild(div);
    });

    document.getElementById('totalLogs').textContent = systemLogs.length;
    document.getElementById('sucessosLogs').textContent = systemLogs.filter(l => l.type === 'success').length;
    document.getElementById('errosLogs').textContent = systemLogs.filter(l => l.type === 'error').length;
    document.getElementById('ultimaAtividade').textContent = systemLogs.length > 0 ? systemLogs[0].timestamp : '-';
  }

  function limparLogs() {
    if (confirm('Tem certeza que deseja limpar todos os logs?')) {
      systemLogs = [];
      localStorage.setItem('system_logs', JSON.stringify(systemLogs));
      atualizarLogs();
      adicionarLog('Todos os logs foram limpos', 'info');
    }
  }

  // ===== FUNÇÕES AUXILIARES =====
  function ligarTodas() { for (let i = 1; i <= 4; i++) controlarLampada(i, true); }
  function desligarTodas() { for (let i = 1; i <= 4; i++) controlarLampada(i, false); }

  // ===== INICIALIZAÇÃO =====
  window.addEventListener('load', () => {
    if (arduinoIP) document.getElementById('arduinoIP').value = arduinoIP;
  });
</script>
</body>
            </html>
